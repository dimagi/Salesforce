<apex:page controller="OpportunityPipelineSnapshotController" docType="html-5.0" action="{!initOpportunityPipelineSnapshot}">
    <apex:pageBlock title="Opportunity Pipeline Snapshot" id="mainBlockId">
        <apex:form >
            <apex:outputPanel >
                <apex:outputPanel layout="block" id="messages">
                    <apex:pageMessages />
                </apex:outputPanel>
            </apex:outputPanel>

            <apex:actionstatus id="loadingDiv">
                <apex:facet name="start">
                    <div class="waitingSearchDiv" id="el_loading" style="background-color: #fbfbfb; height:100%;opacity:0.65;width:100%;">
                        <div class="waitingHolder" style="left : 50%; top : 50%; position: fixed; width: 91px;">
                            <img class="waitingImage" src="{!$Resource.BrokenCircle}" title="Please Wait..." />
                        </div>
                    </div>
                </apex:facet>
            </apex:actionstatus>

            <apex:actionPoller action="{!loadOpportunityPipelineSnapshotBatchJobStatus}" enabled="{!oppSnapshotJobWrapper.isRunning}"
                        reRender="mainBlockId" interval="5"/>

            <apex:pageBlockSection >
                <apex:outputPanel id="jobLoader" rendered="{!oppSnapshotJobWrapper.isRunning}">
                    <apex:image url="/img/loading32.gif" height="10px" />
                    Opportunity Pipeline Snapshot is currently working : {!oppSnapshotJobWrapper.jobItemsProcessed}/{!oppSnapshotJobWrapper.totalJobItems}
                </apex:outputPanel>
            </apex:pageBlockSection>

            <apex:pageBlockSection columns="1" >
                <apex:pageBlockSectionItem rendered="{!!oppSnapshotJobWrapper.isRunning}">
                    <apex:outputText value="Pipeline Snapshot Count : {!currentPSCount} for date : {!lastMonthSnapshotDate}" />
                </apex:pageBlockSectionItem>
                <apex:pageBlockSectionItem >
                    <apex:commandButton onclick="return confirm('Are you sure you want to run this process? It will wipe all {!currentPSCount} snapshots for {!lastMonthSnapshotDate} and create new snapshots.');" action="{!runOpportunityPipelineSnapshotBatchJob}" value="Run Pipeline Snapshot" id="runButton"
                                disabled="{!oppSnapshotJobWrapper.isRunning}" />
                </apex:pageBlockSectionItem>
            </apex:pageBlockSection>
        </apex:form>
    </apex:pageBlock>
</apex:page>